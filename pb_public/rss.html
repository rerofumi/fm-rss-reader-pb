<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>fm-rss-reader-pb | RSS MCP Tester</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6e6e6; }
    header { padding: 16px; background: #141a33; display: flex; align-items: center; justify-content: space-between; }
    header h1 { margin: 0; font-size: 16px; font-weight: 600; }
    header nav a { color: #9fb4ff; text-decoration: none; margin-left: 12px; }
    main { padding: 16px; display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    section { background: #11162b; border: 1px solid #1f274a; border-radius: 8px; padding: 16px; }
    h2 { margin: 0 0 12px; font-size: 14px; color: #9fb4ff; }
    label { display: block; font-size: 12px; margin: 8px 0 4px; color: #c9d3ff; }
    input, select, textarea { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 6px; border: 1px solid #2a355f; background: #0d1330; color: #e6e6e6; }
    textarea { min-height: 120px; resize: vertical; }
    button { padding: 8px 12px; border-radius: 6px; border: 1px solid #2a355f; background: #223068; color: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: default; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .muted { color: #a0a0aa; font-size: 12px; }
    .list { display: grid; gap: 8px; }
    .card { border: 1px solid #2a355f; padding: 8px; border-radius: 6px; background: #0d1330; display: grid; gap: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; word-break: break-word; }
    .ok { color: #8df7b7; }
    .err { color: #ff8aa1; }
    .sep { height: 1px; background: #1f274a; margin: 8px 0; }
  </style>
</head>
<body>
  <header>
    <h1>fm-rss-reader-pb | RSS MCP テスター</h1>
    <nav>
      <a href="/index.html">Home</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>1) 認証ヘッダ</h2>
      <div class="row">
        <div>
          <label for="mcpToken">MCP トークン (MCP-...)</label>
          <input id="mcpToken" placeholder="MCP-xxxxxxxx" />
        </div>
        <div>
          <label for="pbJwt">PocketBase JWT (token)</label>
          <input id="pbJwt" placeholder="pbJWT (users/auth-with-password の token)" />
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button onclick="saveToken()">保存</button>
        <button onclick="loadToken()">読み込み</button>
        <button onclick="clearTokens()">両方クリア</button>
        <span class="muted">どちらか片方をセットしてください（優先順: MCP → PB JWT）。ローカル保存されます。</span>
      </div>
      <div id="tokenMsg" class="mono"></div>
    </section>

    <section>
      <h2>2) tools/list</h2>
      <div class="row">
        <button onclick="fetchTools()">取得</button>
      </div>
      <div class="sep"></div>
      <div id="toolsMsg" class="mono"></div>
      <div id="toolsList" class="card mono"></div>
    </section>

    <section>
      <h2>3) Genres (genre.*)</h2>
      <div class="row">
        <button onclick="genreList()">genre.list</button>
      </div>
      <div class="row">
        <div>
          <label for="genreCreateName">name</label>
          <input id="genreCreateName" />
        </div>
        <button style="flex:0 0 auto" onclick="genreCreate()">genre.create</button>
      </div>
      <div class="row">
        <div>
          <label for="genreUpdateId">id</label>
          <input id="genreUpdateId" />
        </div>
        <div>
          <label for="genreUpdateName">name</label>
          <input id="genreUpdateName" />
        </div>
        <button style="flex:0 0 auto" onclick="genreUpdate()">genre.update</button>
      </div>
      <div class="row">
        <div>
          <label for="genreDeleteId">id</label>
          <input id="genreDeleteId" />
        </div>
        <button style="flex:0 0 auto" onclick="genreDelete()">genre.delete</button>
      </div>
      <div class="sep"></div>
      <div id="genresOut" class="card mono"></div>
    </section>

    <section>
      <h2>4) Feeds (feed.*)</h2>
      <div class="row">
        <div>
          <label for="feedListGenreId">genreId</label>
          <input id="feedListGenreId" />
        </div>
        <button style="flex:0 0 auto" onclick="feedList()">feed.list</button>
      </div>
      <div class="row">
        <div>
          <label for="feedAddGenreId">genreId</label>
          <input id="feedAddGenreId" />
        </div>
        <div>
          <label for="feedAddUrl">url</label>
          <input id="feedAddUrl" placeholder="https://.../feed.xml" />
        </div>
        <button style="flex:0 0 auto" onclick="feedAdd()">feed.add</button>
      </div>
      <div class="row">
        <div>
          <label for="feedRemoveId">id</label>
          <input id="feedRemoveId" />
        </div>
        <button style="flex:0 0 auto" onclick="feedRemove()">feed.remove</button>
      </div>
      <div class="sep"></div>
      <div id="feedsOut" class="card mono"></div>
    </section>

    <section>
      <h2>5) Articles (articles.*)</h2>
      <div class="row">
        <div>
          <label for="articlesByGenreId">genreId</label>
          <input id="articlesByGenreId" />
        </div>
        <div>
          <label for="articlesByGenreLimit">limit</label>
          <input id="articlesByGenreLimit" type="number" placeholder="50" />
        </div>
        <button style="flex:0 0 auto" onclick="articlesFetchByGenre()">articles.fetchByGenre</button>
      </div>
      <div class="row">
        <div>
          <label for="articlesByUrlUrl">url</label>
          <input id="articlesByUrlUrl" placeholder="https://.../feed.xml" />
        </div>
        <div>
          <label for="articlesByUrlLimit">limit</label>
          <input id="articlesByUrlLimit" type="number" placeholder="50" />
        </div>
        <button style="flex:0 0 auto" onclick="articlesFetchByUrl()">articles.fetchByUrl</button>
      </div>
      <div class="sep"></div>
      <div id="articlesOut" class="card mono"></div>
    </section>

    <section>
      <h2>6) 最終レスポンス</h2>
      <div id="lastOut" class="card mono"></div>
    </section>
  </main>

  <script>
  function esc(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function setMsg(id, text, err=false) {
    const el = document.getElementById(id); if (!el) return; el.textContent = text; el.className = 'mono ' + (err?'err':'ok');
  }
  function setJson(id, obj) {
    const el = document.getElementById(id); if (!el) return; el.textContent = JSON.stringify(obj, null, 2);
  }
  function getResultContentText(resp) {
    try {
      const content = resp?.result?.content || resp?.content || [];
      if (Array.isArray(content) && content.length && content[0]?.type === 'text') {
        return String(content[0].text || '');
      }
    } catch(_){}
    return '';
  }
  function getResultParsed(resp) {
    const txt = getResultContentText(resp);
    if (!txt) return null;
    try { return JSON.parse(txt); } catch { return txt; }
  }
  function clearEl(id) { const el = document.getElementById(id); if (el) el.innerHTML = ''; }
  function renderList(id, items, lineRenderer) {
    const el = document.getElementById(id); if (!el) return;
    el.innerHTML = '';
    if (!items || !items.length) { el.textContent = '(empty)'; return; }
    for (const it of items) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = lineRenderer(it);
      el.appendChild(div);
    }
  }
  function renderGenresOut(resp) {
    const p = getResultParsed(resp.data || resp);
    if (p && typeof p === 'object' && Array.isArray(p.genres)) {
      renderList('genresOut', p.genres, (g) => `
        <div><strong>${esc(g.name || '')}</strong></div>
        <div class="mono muted">id: ${esc(g.id || '')}</div>
        <div class="mono muted">createdAt: ${esc(g.createdAt || '')}</div>
      `);
    } else {
      setJson('genresOut', resp.data?.result || resp.data || resp);
    }
  }
  function renderFeedsOut(resp) {
    const p = getResultParsed(resp.data || resp);
    if (p && typeof p === 'object' && Array.isArray(p.feeds)) {
      renderList('feedsOut', p.feeds, (f) => `
        <div><strong>${esc(f.title || '')}</strong></div>
        <div><a href="${esc(f.url || '')}" target="_blank" rel="noopener">${esc(f.url || '')}</a></div>
        <div class="mono muted">id: ${esc(f.id || '')}</div>
        <div class="mono muted">createdAt: ${esc(f.createdAt || '')}</div>
      `);
    } else {
      setJson('feedsOut', resp.data?.result || resp.data || resp);
    }
  }
  function renderArticlesOut(resp) {
    const p = getResultParsed(resp.data || resp);
    const articles = (p && typeof p === 'object' && Array.isArray(p.articles)) ? p.articles : null;
    const el = document.getElementById('articlesOut'); if (!el) return;
    el.innerHTML = '';
    if (!articles || !articles.length) { el.textContent = '(no articles)'; return; }
    for (const a of articles) {
      const card = document.createElement('div');
      card.className = 'card';
      const title = esc(a.title || '');
      const url = esc(a.link || '');
      const desc = esc(a.description || a.contentSnippet || '');
      const feedTitle = esc(a?.feed?.title || '');
      const pub = esc(a.published || '');
      card.innerHTML = `
        <div><a href="${url}" target="_blank" rel="noopener"><strong>${title}</strong></a></div>
        <div class="muted">${desc}</div>
        <div class="mono muted">${feedTitle ? 'feed: ' + feedTitle + ' | ' : ''}${pub}</div>
      `;
      el.appendChild(card);
    }
  }
  function saveToken() {
    const m = document.getElementById('mcpToken').value.trim();
    const p = document.getElementById('pbJwt').value.trim();
    if (!m && !p) { setMsg('tokenMsg', 'MCP または PB JWT のいずれかを入力してください', true); return; }
    if (m) localStorage.setItem('mcp_token', m); else localStorage.removeItem('mcp_token');
    if (p) localStorage.setItem('pb_jwt_alt', p); else localStorage.removeItem('pb_jwt_alt');
    setMsg('tokenMsg', '保存しました');
  }
  function loadToken() {
    const m = localStorage.getItem('mcp_token') || '';
    const p = localStorage.getItem('pb_jwt_alt') || '';
    document.getElementById('mcpToken').value = m;
    document.getElementById('pbJwt').value = p;
    setMsg('tokenMsg', (m||p) ? '読み込みました' : '保存されたトークンがありません', !(m||p));
  }
  function authHeader() {
    const m = document.getElementById('mcpToken').value.trim();
    const p = document.getElementById('pbJwt').value.trim();
    const token = m || p; // MCP を優先
    return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
  }
  function clearTokens() {
    localStorage.removeItem('mcp_token');
    localStorage.removeItem('pb_jwt_alt');
    document.getElementById('mcpToken').value = '';
    document.getElementById('pbJwt').value = '';
    setMsg('tokenMsg', 'MCP/PB JWT をクリアしました');
  }
  async function rpcCall(method, params) {
    const body = { jsonrpc: '2.0', id: String(Date.now()), method, params: params || {} };
    const res = await fetch('/mcp/rss', { method: 'POST', headers: authHeader(), body: JSON.stringify(body) });
    const text = await res.text();
    let data; try { data = JSON.parse(text); } catch { data = { raw: text }; }
    setJson('lastOut', data);
    return { ok: res.ok, status: res.status, data };
  }
  async function rpcTool(name, args) {
    return rpcCall('tools/call', { name, arguments: args || {} });
  }

  // tools/list
  async function fetchTools() {
    setMsg('toolsMsg', '取得中...');
    try {
      const r = await rpcCall('tools/list', {});
      if (!r.ok) throw new Error('HTTP ' + r.status);
      setJson('toolsList', r.data.result || r.data);
      setMsg('toolsMsg', 'OK');
    } catch (e) {
      setMsg('toolsMsg', 'エラー: ' + e.message, true);
    }
  }

  // genre.*
  async function genreList() {
    const r = await rpcTool('genre.list', {});
    renderGenresOut(r);
  }
  async function genreCreate() {
    const name = document.getElementById('genreCreateName').value.trim();
    if (!name) { alert('name を入力してください'); return; }
    const r = await rpcTool('genre.create', { name });
    renderGenresOut(r);
  }
  async function genreUpdate() {
    const id = document.getElementById('genreUpdateId').value.trim();
    const name = document.getElementById('genreUpdateName').value.trim();
    if (!id || !name) { alert('id と name を入力してください'); return; }
    const r = await rpcTool('genre.update', { id, name });
    renderGenresOut(r);
  }
  async function genreDelete() {
    const id = document.getElementById('genreDeleteId').value.trim();
    if (!id) { alert('id を入力してください'); return; }
    const r = await rpcTool('genre.delete', { id });
    renderGenresOut(r);
  }

  // feed.*
  async function feedList() {
    const genreId = document.getElementById('feedListGenreId').value.trim();
    if (!genreId) { alert('genreId を入力してください'); return; }
    const r = await rpcTool('feed.list', { genreId });
    renderFeedsOut(r);
  }
  async function feedAdd() {
    const genreId = document.getElementById('feedAddGenreId').value.trim();
    const url = document.getElementById('feedAddUrl').value.trim();
    if (!genreId || !url) { alert('genreId と url を入力してください'); return; }
    const r = await rpcTool('feed.add', { genreId, url });
    renderFeedsOut(r);
  }
  async function feedRemove() {
    const id = document.getElementById('feedRemoveId').value.trim();
    if (!id) { alert('id を入力してください'); return; }
    const r = await rpcTool('feed.remove', { id });
    renderFeedsOut(r);
  }

  // articles.*
  async function articlesFetchByGenre() {
    const genreId = document.getElementById('articlesByGenreId').value.trim();
    const limit = parseInt(document.getElementById('articlesByGenreLimit').value, 10);
    const args = { genreId };
    if (!isNaN(limit) && limit > 0) args.limit = limit;
    const r = await rpcTool('articles.fetchByGenre', args);
    renderArticlesOut(r);
  }
  async function articlesFetchByUrl() {
    const url = document.getElementById('articlesByUrlUrl').value.trim();
    const limit = parseInt(document.getElementById('articlesByUrlLimit').value, 10);
    const args = { url };
    if (!isNaN(limit) && limit > 0) args.limit = limit;
    const r = await rpcTool('articles.fetchByUrl', args);
    renderArticlesOut(r);
  }

  // boot
  loadToken();
  </script>
</body>
</html>
