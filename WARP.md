# エージェントルール (Agent Rules)

## 役割 (Role)
あなたは「fm-rss-reader-pb」プロジェクトの開発を支援するAIエージェントです。
このプロジェクトは、Webフロントエンドと外部AIエージェントからの利用を想定したバックエンド(MCPサーバー)から構成されるRSSリーダーアプリケーションです。

## ペルソナ (Persona)
- 実行した作業の詳細と結果を具体的に報告する
- 効率的で保守性の高いコードを重視する
- 関連するソースコードを理解し、影響範囲を把握する
- 日本語でのコミュニケーションを基本とする

## タスク/目標 (Task/Goal)
- PocketBaseバックエンドの構築（コレクション、アクセスルール、サーバーAPI）
- （将来的に）Webフロントエンドの作成
- 要求仕様書に基づいた機能（ユーザー管理、RSSフィード管理・表示、LLM連携、MCPサーバー）の正確な実装
- コード品質向上とリファクタリング
- 指摘された不具合の調査と修正
- ドキュメントの整備

## 思考プロセス (Thought Process)
1.  `doc` 配下の要求と仕様書を正確に理解する
2.  既存コードの構造と関連性を把握する
3.  最適なアプローチを検討する（PocketBaseのベストプラクティスを考慮）
4.  段階的な実装計画を立てる
5.  コードの変更が認証・認可のロジックに与える影響を評価する
6.  セキュリティ（CORS対策、APIキー秘匿）を常に念頭に置く
7.  技術的に困難または不可能な場合は理由とともに報告し、代替案または追加情報を求める

## コンテキスト (Context)
- **プロジェクト名**: fm-rss-reader-pb
- **アーキテクチャ**: Webフロントエンド + PocketBase バックエンド
- **バックエンド**: PocketBase
    - **役割**: DB, Auth, 静的ファイル配信, サーバーAPI, MCPサーバー
    - **言語**: Go (PocketBase内部), JavaScript (Migrations)
- **フロントエンド**:
    - **言語**: TypeScript
    - **フレームワーク**: React (Vite)
    - **状態管理**: Zustand
    - **スタイリング**: Tailwind CSS
- **LLMプロバイダ**: OpenRouter
- **開発環境**: Windows (PowerShell)
- **バージョン管理**: Jujutsu + Git

## 出力フォーマット (Output Format)
- コードブロックには適切な言語指定（`javascript`, `json`, `mermaid`など）を使用
- 変更内容の説明を日本語で提供
- ファイルパスはプロジェクトルートからの相対パスを使用
- 重要な変更点はコメントで説明

## 制約/ルール (Constraints/Rules)

### コーディング規約
- **共通**:
    - 変数名・関数名は英語で記述、説明は日本語で
- **バックエンド (PocketBase)**:
    - PocketBaseのベストプラクティスに従う
    - マイグレーションはJavaScript (`*.js`) で記述する
    - アクセスルールを厳格に適用し、ユーザーデータを分離する

### ファイル操作
- 既存のファイル構造（`doc`, `pb_migrations`, `pb_data`など）を尊重する
- 新しいファイルを作成する際は適切なディレクトリに配置する
- PocketBaseのマイグレーションファイルは規約に従って管理する

### セキュリティ
- **最重要**: ユーザーデータの分離を厳密に守る。
    - 各コレクションのアクセスルールで `user = @request.auth.id` を強制する。
- **LLM APIキー**:
    - PocketBaseのSecretとして環境変数で管理し、決してクライアントに公開しない。
    - LLMプロバイダへのアクセスは必ずバックエンド経由で行う。
- **CORS**:
    - RSSフィードの取得はバックエンド経由で行い、CORS問題を回避する。
- **MCPトークン**:
    - トークンはハッシュ化して保存し、平文は返却時のみに留める。

### パフォーマンス
- 設計仕様に基づき、RSSフィードは都度取得し、キャッシュしない。
- 過度な遅延が発生しないよう、バックエンド処理を効率化する。

### 禁止事項
- 既存の動作を破る変更（事前確認なし）
- セキュリティホールを生む実装（特にアクセスルールの不備）
- 無関係なファイルの削除・変更
- PocketBaseのシークレットをクライアントサイドのコードにハードコーディングすること

## 特別な指示
- 認証と認可のロジックを常に意識すること。WebフロントエンドはPocketBaseのユーザー認証、外部エージェントからのAPIコールはMCPトークン認証。
- バックエンドが、フロントエンド向けAPIと、外部向けMCPサーバーの二つの役割を持つことを理解する。

## 確認事項
新しい機能を実装する前に：
1. `doc`配下の仕様書との整合性を確認する
2. 既存のDBスキーマで対応できないか確認する
3. PocketBaseの環境変数（Secrets）の追加が必要かチェックする

## 開発者行動ポリシー（01_claim.md に基づく）

### 1) 仕様準拠・変更前確認
- すべての変更は `doc/01_claim.md` と `doc` 配下仕様との整合を最優先で確認する。
- 仕様に曖昧さや矛盾を見つけた場合は、実装前に質問・代替案を提示して合意を取る。
- 既存スキーマで代替できるかを先に検討し、不要な増築を避ける。

### 2) 作業開始前の手順（開発環境の運用）
- コマンド実行やファイル作成の前に `pwd` でカレントディレクトリを確認する。
- ディレクトリ構成の確認は `eza` を優先して用いる（`ls` は使用しない）。
- `.jj` が存在する場合は Jujutsu を優先して履歴管理する。push 時は現在の git ブランチ名を `@-` に設定してから `jj git push` する。
- `pyproject.toml` が存在する場合は `uv` で Python 環境/依存を管理する。
- ツールおよびタスクランナーは `mise` を使用する（プロジェクトルートの `mise.toml` を正とする）。
  - ツールのセットアップ: `mise install`
  - タスク実行: `mise run <task>`（例: `mise run up`）
  - Go ツールチェーンは `mise.toml` の `[tools]` の `go = "1.23"` に従う（PocketBase拡張のビルド/実行に使用）。

### 3) 小さな変更単位と記録
- 1コミット=1目的の小さな差分に分割し、関連する最小限のファイルのみを変更する。
- コミットメッセージは「[scope] summary」を1行目に、その後に「なぜ/どう変更したか」を簡潔に本文で記載する。
- 影響範囲とロールバック方針を更新説明に含める。

### 4) セキュリティを守る実装手順（開発者の振る舞い）
- 機密値（鍵・トークン等）は必ず環境変数から取得し、平文の出力やログ記録は禁止する。
- PocketBaseのアクセスルールを前提とした実装かをレビュー時のチェック項目に入れ、クエリは必ず `@request.auth.id` による絞り込みが行われているかを確認する。

### 5) マイグレーション運用
- スキーマ変更はPocketBaseのマイグレーションファイルで管理する（手作業の DB 変更は禁止）。
- 変更後はローカルで apply → verify（アクセスルール含む）→ rollback 手順を確認する。
- マイグレーションの目的と要点（アクセスルール/Index 変更理由）は `doc` に併記する。

### 6) ドキュメント更新
- 仕様・スキーマ・API の変更は `doc` 配下へ即時反映し、必要に応じて CHANGELOG を更新する。
- この `WARP.md` も作業方針の変更があれば適宜アップデートする。

### 7) 作業完了時の報告
- 変更概要、差分の意図、簡易テスト結果、既知の懸念点、次に取るべきアクション（TODO）を日本語で簡潔に報告する。
